"use strict";document.documentElement.style.overflowY="hidden";var starkAPP=angular.module("starkAPP",["ngRoute","ngAnimate","routeStyles","baseService"]).config(["$compileProvider","$routeProvider","$locationProvider",function(e,t,o){t.when("/main/",{templateUrl:"./html/main.html"}).when("/all/",{templateUrl:"./html/all.html"}).when("/collection/",{templateUrl:"./html/collection.html"}).when("/forum/",{templateUrl:"./html/forum.html"}).when("/forum/course/",{templateUrl:"./html/forum_course.html"}).otherwise({redirectTo:"/main/"})}]);angular.module("baseService",[]).factory("BaseService",["$rootScope","$http",function(e,t){function o(e,t){if(e.keywords){var o=new RegExp(e.keywords.trim(),"i");if(!o.test(t["课程名称"])&&!o.test(t["教师"])&&!o.test(t["选课序号"]))return!1}if(e.time){for(var a=t["时间"].split("{time}"),r=0;r<a.length;r++){if(0===a[r].trim().length)return!0;if(i(e.time.start,e.time.end,a[r].trim()))return!0}return!1}return!0}function a(e){if(0===e.category.length)return[];if(0===e.keywords.length&&9===e.category.length)return[];var t=[];if(e.category.length>0)e.category.forEach(function(a){COURSE_DATA[a].forEach(function(a){o(e,a)&&t.push(a)})});else for(var a in COURSE_DATA)COURSE_DATA[a].forEach(function(a){o(e,a)&&t.push(a)});return t}function r(e){var t=e.trim(),o=n(t.split(" ")[0]),a=parseInt(t.split(" ")[1].split("-")[1])-parseInt(t.split(" ")[1].split("-")[0])+1,r=parseInt(t.split(" ")[1].split("-")[0]);return{weekday:o-1,length:a,start:r-1}}function n(e){var t;switch(e){case"一":t=1;break;case"二":t=2;break;case"三":t=3;break;case"四":t=4;break;case"五":t=5;break;case"六":t=6}return t}function i(e,t,o){var a=o.trim().split(" ")[0],r=o.trim().split(" ")[1].split("-")[0],n=o.trim().split(" ")[1].split("-")[1],i=a+" "+r,c=a+" "+n;return l(e,i)&&l(c,t)?!0:!1}function l(e,t){var o=n(e.trim().split(" ")[0]),a=n(t.trim().split(" ")[0]),r=parseInt(e.trim().split(" ")[1]),i=parseInt(t.trim().split(" ")[1]);return o===a?i>=r:a>o}String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"")};var c={data:[[],[],[],[],[],[]],init:function(){this.data.forEach(function(e){for(var t=0;13>t;t++)e.push(0)}),void 0!==localStorage.courseModelData&&(this.data=JSON.parse(localStorage.courseModelData))},update:function(t){for(var o=t["时间"].split("{time}"),a=this,n=[],i=[],l=0;l<o.length;l++){console.log("check");for(var c=r(o[l]),s=c.weekday,u=c.start,d=c.length,h=0;d>h;h++)console.log(this.data[s][u+h]),0!=this.data[s][u+h]&&-1==n.indexOf(this.data[s][u+h]["课程名称"])&&(n.push(this.data[s][u+h]["课程名称"]),i.push(this.data[s][u+h]))}var f=n.length>1?n.join("》、《"):n[0];if(n.length>0){if(!confirm("这门课与《"+f+"》冲突，是否替换？"))return;i.forEach(function(e){a.remove(e)}),this.update(t)}for(var l=0;l<o.length;l++){var c=r(o[l]),s=c.weekday,u=c.start,d=c.length,p=l;a.updateOne(t,s,u,d,p)}var m=this.data;localStorage.courseModelData=JSON.stringify(m),e.$broadcast("courseModelUpdate",m)},updateOne:function(e,t,o,a,r){for(var n=0;a>n;n++)c.data[t][o+n]=e,c.data[t][o+n].rank=r},remove:function(t){var o=t["时间"].split("{time}"),a=this;o.forEach(function(e){var o=r(e);a.removeOne(t,o)});var n=this.data;localStorage.courseModelData=JSON.stringify(n),e.$broadcast("courseModelUpdate",n)},removeOne:function(e,t){for(var o=t.weekday,a=0;13>a;a++)this.data[o][a]["选课序号"]==e["选课序号"]&&(this.data[o][a]=0)},check:function(e){var t=[];return this.data.forEach(function(e){e.forEach(function(e){0!=e&&-1===t.indexOf(e["选课序号"])&&t.push(e["选课序号"])})}),-1!=t.indexOf(e)},getCourseData:function(){var e=[],t=[],o=["#66CCFF","#FF9900","#99CC33","#FF6666","#33CC99","#336699","#CCCC44","#339933"],a=0;return this.data.forEach(function(n){n.forEach(function(n){if(console.log(n),n&&-1===t.indexOf(n["选课序号"])){var i=n["时间"].split("{time}");i.forEach(function(t){var i={name:n["课程名称"],day:r(t).weekday,section:t.split(" ")[1],info:n["教室"]+"("+n["教师"]+")","background-color":o[a]};e.push(i)}),a++,a===o.length&&(a=0),t.push(n["选课序号"])}})}),e}};c.init();var s={data:[],init:function(){void 0!==localStorage.collectionModelData&&(this.data=JSON.parse(localStorage.collectionModelData))},update:function(t){for(var o=0;o<this.data.length;o++)if(this.data[o]["选课序号"]==t["选课序号"])return;this.data.push(t);var a=this.data;localStorage.collectionModelData=JSON.stringify(a),e.$broadcast("collectionUpdate",a)},remove:function(t){for(var o=0;o<this.data.length;o++)if(this.data[o]["选课序号"]==t){this.data.splice(o,1);break}var a=this.data;localStorage.collectionModelData=JSON.stringify(a),e.$broadcast("collectionUpdate",a)},check:function(e){for(var t=0;t<this.data.length;t++)if(this.data[t]["选课序号"]==e)return!0;return!1}};s.init();var u=function(e){return t.post("/xk/api/",e)},d={search:a,timeParser:r,courseModel:c,collectionModel:s,judgeTime:i,saveToPhone:u};return d}]).filter("timeFilter",function(){var e=function(e){return void 0!=e?e.replace(/{time}/g,"，"):e};return e}),angular.module("starkAPP").controller("allController",["$scope","$rootScope","BaseService","$timeout","$location",function(e,t,o,a,r){var n=[];for(name in COURSE_DATA)n.push({name:name,courses:COURSE_DATA[name]});e.data=n;var i;e.handle={},e.showHandle=function(){var e=e||window.event;i=this.course,this.$parent.category.handle={},o.courseModel.check(this.course["选课序号"])?(this.$parent.category.handle.text1="已选入课表",this.$parent.category.handle.isInCourseTable=!0):(this.$parent.category.handle.text1="加入课表",this.$parent.category.handle.isInCourseTable=!1),o.collectionModel.check(this.course["选课序号"])?(this.$parent.category.handle.text2="已在收藏夹",this.$parent.category.handle.isInCollection=!0):(this.$parent.category.handle.text2="加入收藏夹",this.$parent.category.handle.isInCollection=!1);var t=e.clientY,a=e.clientX;this.$parent.category.handle.name=this.course["课程名称"],this.$parent.category.handle.teacher=this.course["教师"],this.$parent.category.handle.position="left:"+a+"px;top:"+t+"px;",this.$parent.category.handleIsShow=!0},e.closeHandle=function(){this.category.handleIsShow=!1},e.update=function(){o.courseModel.update(i)},e.addIntoBox=function(){o.collectionModel.update(i)}}]),angular.module("starkAPP").controller("collectionController",["$scope","$rootScope","BaseService","$timeout","$location",function(e,t,o,a,r){function n(){e.courses=o.collectionModel.data,e.courses.forEach(function(e){o.courseModel.check(e["选课序号"])?e.isInCourseTable=!0:e.isInCourseTable=!1,e.text=e.isInCourseTable?"已加入课表":"加入课表"})}n(),e.$on("collectionUpdate",function(e){n()}),e.$on("courseModelUpdate",function(e){n()}),e.addCourse=function(){o.courseModel.update(this.course)},e.remove=function(){o.collectionModel.remove(this.course["选课序号"])};new Clipboard(".copy")}]),angular.module("starkAPP").controller("courseTableController",["$scope","BaseService","$timeout",function(e,t,o){function a(o){function a(t,o){if(2==o.length&&(e.tableView[o.weekday][o.start]={text1:t["选课序号"],text2:t["课程名称"],length:o.length,No:0,show:!0,style:"",locate:"start"},e.tableView[o.weekday][o.start+1]={text1:t["教室"],text2:t["教师"],length:o.length,No:1,show:!0,locate:"end"}),3==o.length&&(e.tableView[o.weekday][o.start]={text1:t["选课序号"],length:o.length,No:0,show:!0,style:"",locate:"start"},e.tableView[o.weekday][o.start+1]={text1:t["课程名称"],length:o.length,No:1,show:!0,style:"",locate:"body"},e.tableView[o.weekday][o.start+2]={text1:t["教室"],text2:t["教师"],length:o.length,No:2,show:!0,style:"",locate:"end"}),o.length>=4){for(var a=["选课序号","课程名称","教室","教师"],r=Math.floor((o.length-4)/2),n=0;n<o.length;n++)e.tableView[o.weekday][o.start+n]={length:o.length,No:n,show:!0,style:"",locate:"body"},0==n&&(e.tableView[o.weekday][o.start+n].locate="start"),n==o.length-1&&(e.tableView[o.weekday][o.start+n].locate="end");for(var n=0;4>n;n++){e.tableView[o.weekday][o.start+r+n].text1=t[a[n]]}}}e.tableView=[[],[],[],[],[],[]],e.tableView.forEach(function(e){for(var t=0;13>t;t++)e.push({length:1})});var r=[];o.forEach(function(e){e.forEach(function(e){0!=e&&r.push(e)})}),r.forEach(function(e){for(var o=e["时间"].split("{time}"),r=0;r<o.length;r++){var n=t.timeParser(o[r]);a(e,n)}})}a(t.courseModel.data),e.$on("courseModelUpdate",function(e,t){a(t)}),e.remove=function(e,o){var a=t.courseModel.data[e][o];t.courseModel.remove(a)},e.hover=function(t,o){for(var a="background:#ddd",r=e.tableView[o][t].No||0,n=e.tableView[o][t].length-r-1||0,i=0;r>=i;i++)e.tableView[o][t-i].style=a;for(var i=0;n>=i;i++)e.tableView[o][t+i].style=a},e.out=function(t,o){for(var a="",r=e.tableView[o][t].No||0,n=e.tableView[o][t].length-r-1||0,i=0;r>=i;i++)e.tableView[o][t-i].style=a;for(var i=0;n>=i;i++)e.tableView[o][t+i].style=a},e.showDetail=function(a,r,n){var i=i||window.event||n;if(0!==t.courseModel.data[a][r]){if(e.detail=t.courseModel.data[a][r],1==e.detailIsShow?(e.detailIsShow=!1,o(function(){e.detailIsShow=!0},0)):e.detailIsShow=!0,0===a||1===a||2===a){var l;l=void 0!=i.layerY?i.layerY-100<0?0:i.layerY-100:i.clientY+$("#bg")[0].scrollTop-100;var c=15*(a+1)+10;e.detailPosition="top:"+l+"px;left:"+c+"%;"}if(3===a||4===a||5===a){var l;l=void 0!=i.layerY?i.layerY-100<0?0:i.layerY-100:i.clientY+$("#bg")[0].scrollTop-100;var s=15*(6-a);e.detailPosition="top:"+l+"px;right:"+s+"%;"}}},e.closeDetail=function(){e.detailIsShow=!1},e.removeCourse=function(){t.courseModel.remove(e.detail)},e.saveToPhone=function(){var o={courses:t.courseModel.getCourseData(),"day-content":["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],"line-color":"#fff","background-color":"#fff",width:480,height:960,"font-size":36,"info-font-size":30,"header-font-size":30,"siderbar-font-size":24},a=JSON.stringify(o);console.log(a),t.saveToPhone({course_data:a}).then(function(t){e.qrcode=!0;var o="http://stu.fudan.edu.cn/xk/img/"+t.data;$(".qrcode").html(""),$(".qrcode").qrcode({width:200,height:200,text:o})})},e.hideQrcode=function(){e.qrcode=!1}}]),angular.module("starkAPP").controller("courseTotalController",["$scope","BaseService",function(e,t){function o(t){var o=[],a=[],r=0;t.forEach(function(e){e.forEach(function(e){0!=e&&-1===a.indexOf(e["选课序号"])&&(a.push(e["选课序号"]),o.push(e),r+=parseInt(e["学分"]))})}),e.list=o,e.totalCredit=r}o(t.courseModel.data),e.$on("courseModelUpdate",function(e,t){o(t)})}]),angular.module("starkAPP").controller("forumController",["$scope","BaseService",function(e,t){e.commentTitle="点击此处可分享你的上课心得（已有999条评论）",e.showComment=function(){e.commentShow=!e.commentShow,e.commentShow?e.commentTitle="发表评论":e.commentTitle="点击此处可分享你的上课心得（已有999条评论）"},e.search=function(){return e.keywords.length>0?void(e.isSearch=!0):void(e.isSearch=!1)},e.open=function(){window.open("http://stu.fudan.edu.cn/xk/#/forum/course/")}}]),angular.module("starkAPP").controller("forumCourseController",["$scope","BaseService",function(e,t){}]),angular.module("starkAPP").controller("searchController",["$scope","BaseService","$timeout","$location",function(e,t,o,a){function r(){e.certainCategory={"二专课程":!0,"军事理论":!0,"大学外语":!0,"文科专业课":!0,"模块课程":!0,"理科课程":!0,"留学生":!0,"美育":!0,"计算机":!0}}function n(){e.certainTime={startDay:"一",endDay:"六",startCourse:"1",endCourse:"13"}}function i(o){t.courseModel.check(o)?(e.detail.isInCourseTable=!0,e.detail.text1="已加入课表"):(e.detail.isInCourseTable=!1,e.detail.text1="加入课表"),t.collectionModel.check(o)?(e.detail.isInCollection=!0,e.detail.text2="已在收藏夹"):(e.detail.isInCollection=!1,e.detail.text2="加入收藏夹")}e.$on("showSearch",function(){$(".search").css("z-index","100"),e.searchShow=!0,o(function(){$(".search-bar input").focus()},700)}),e.moreSearchShow=!1,e.keywords="",n(),r(),e.close=function(t){var a=t;/bg/.test(a.target.className)&&(e.searchShow=!1,o(function(){$(".search").css("z-index","-9999")},700))},e.kwChange=function(){var o=[],a={start:e.certainTime.startDay+" "+e.certainTime.startCourse,end:e.certainTime.endDay+" "+e.certainTime.endCourse};for(var r in e.certainCategory)e.certainCategory[r]&&o.push(r);var n={category:o,keywords:e.keywords,time:a};e.result=t.search(n),e.result.length>0?e.resultShow=!0:e.resultShow=!1},e.mouseover=function(){e.detail=this.course,i(e.detail["选课序号"])},e.$on("courseModelUpdate",function(){i(e.detail["选课序号"])}),e.$on("collectionUpdate",function(){i(e.detail["选课序号"])}),e.courseUpdate=function(){t.courseModel.update(this.detail)},e.collectionUpdate=function(){t.collectionModel.update(this.detail)},e.moreSearch=function(){e.moreSearchShow=!e.moreSearchShow}}]),angular.module("starkAPP").controller("sidebarController",["$scope","$rootScope","BaseService","$timeout","$location",function(e,t,o,a,r){function n(){e.active={};var t=r.path().split("/")[1];e.active[t+"IsActive"]=!0}n(),e.changeURL=function(e){r.url(e),n()},e.showSearch=function(){t.$broadcast("showSearch")}}]);