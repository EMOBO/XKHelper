"use strict";var starkAPP=angular.module("starkAPP",["ngRoute","ngAnimate","routeStyles","baseService"]).config(["$compileProvider","$routeProvider","$locationProvider",function(e,t,a){t.when("/main/",{templateUrl:"./html/main.html"}).when("/all/",{templateUrl:"./html/all.html"}).otherwise({redirectTo:"/main/"})}]);angular.module("baseService",[]).factory("BaseService",["$rootScope",function(e){function t(e){function t(e,t){return e.time&&-1==e.time.indexOf(t["时间"].trim())?!1:e.keywords&&-1==t["课程名称"].trim().indexOf(e.keywords.trim())?!1:e.courseID&&-1==t["选课序号"].trim().indexOf(e.courseID.trim())?!1:!0}if(!(e.time.length||e.keywords.length||e.courseID.length||e.category.length))return[];var a=[];if(e.category.length>0)e.category.forEach(function(o){COURSE_DATA[o].forEach(function(o){t(e,o)&&a.push(o)})});else for(var o in COURSE_DATA)COURSE_DATA[o].forEach(function(o){t(e,o)&&a.push(o)});return a}function a(e){var t,a=e.trim();switch(a.split(" ")[0]){case"一":t=1;break;case"二":t=2;break;case"三":t=3;break;case"四":t=4;break;case"五":t=5;break;case"六":t=6}var o=parseInt(a.split(" ")[1].split("-")[1])-parseInt(a.split(" ")[1].split("-")[0])+1,r=parseInt(a.split(" ")[1].split("-")[0]);return{weekday:t-1,length:o,start:r-1}}String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"")};var o={data:[[],[],[],[],[],[]],init:function(){this.data.forEach(function(e){for(var t=0;13>t;t++)e.push(0)}),void 0!==localStorage.courseModelData&&(this.data=JSON.parse(localStorage.courseModelData))},update:function(t){for(var o=t["时间"].split("{time}"),r=this,n=0;n<o.length;n++){var i=a(o[n]),l=i.weekday,s=i.start,c=i.length,h=n+1-1;r.updateOne(t,l,s,c,h)}var u=this.data;localStorage.courseModelData=JSON.stringify(u),e.$broadcast("courseModelUpdate",u)},updateOne:function(e,t,a,r,n){for(var i=!1,l=this,s=0;r>s;s++)0!=this.data[t][a+s]&&(i=!0);if(console.log(i),i){for(var c=[],h=[],s=0;r>s;s++)-1==c.indexOf(this.data[t][a+s]["课程名称"])&&0!=this.data[t][a+s]&&(c.push(this.data[t][a+s]["课程名称"]),h.push(this.data[t][a+s]));console.log(c);var u=c.length>1?c.join("》、《"):c[0];confirm("这门课与《"+u+"》冲突，是否替换？")&&(h.forEach(function(e){l.remove(e),console.log(e)}),this.update(e))}else for(var s=0;r>s;s++)o.data[t][a+s]=e,o.data[t][a+s].rank=n},remove:function(e){var t=e["时间"].split("{time}"),o=this;t.forEach(function(t){var r=a(t);o.removeOne(e,r)})},removeOne:function(t,a){for(var o=a.weekday,r=0;13>r;r++)this.data[o][r]["选课序号"]==t["选课序号"]&&(this.data[o][r]=0);var n=this.data;localStorage.courseModelData=JSON.stringify(n),e.$broadcast("courseModelUpdate",n)},check:function(e){var t=[];return this.data.forEach(function(e){e.forEach(function(e){0!=e&&-1===t.indexOf(e["选课序号"])&&t.push(e["选课序号"])})}),-1!=t.indexOf(e)}};o.init();var r={search:t,timeParser:a,courseModel:o};return r}]).filter("timeFilter",function(){var e=function(e){return void 0!=e?e.replace(/{time}/g,"，"):e};return e}),angular.module("starkAPP").controller("allController",["$scope","$rootScope","BaseService","$timeout","$location",function(e,t,a,o,r){var n=[];for(name in COURSE_DATA)n.push({name:name,courses:COURSE_DATA[name]});e.data=n;var i;e.handle={},e.showHandle=function(){var t=t||window.event;i=this.course,this.$parent.category.handle={},a.courseModel.check(this.course["选课序号"])?(this.$parent.category.handle.text1="已选入课表",e.update=function(){alert("已经在课表里啦~")}):(this.$parent.category.handle.text1="加入课表",e.update=function(){a.courseModel.update(i)});var o=t.clientY,r=t.clientX;this.$parent.category.handle.name=this.course["课程名称"],this.$parent.category.handle.teacher=this.course["教师"],this.$parent.category.handle.position="left:"+r+"px;top:"+o+"px;",this.$parent.category.handleIsShow=!0,console.log(t,this)},e.closeHandle=function(){this.category.handleIsShow=!1}}]),angular.module("starkAPP").controller("courseTableController",["$scope","BaseService","$timeout",function(e,t,a){function o(a){function o(t,a){if(2==a.length&&(e.tableView[a.weekday][a.start]={text1:t["选课序号"],text2:t["课程名称"],length:a.length,No:0,show:!0,style:"",locate:"start"},e.tableView[a.weekday][a.start+1]={text1:t["教室"],text2:t["教师"],length:a.length,No:1,show:!0,locate:"end"}),3==a.length&&(e.tableView[a.weekday][a.start]={text1:t["选课序号"],length:a.length,No:0,show:!0,style:"",locate:"start"},e.tableView[a.weekday][a.start+1]={text1:t["课程名称"],length:a.length,No:1,show:!0,style:"",locate:"body"},e.tableView[a.weekday][a.start+2]={text1:t["教室"],text2:t["教师"],length:a.length,No:2,show:!0,style:"",locate:"end"}),a.length>=4){for(var o=["选课序号","课程名称","教室","教师"],r=Math.floor((a.length-4)/2),n=0;n<a.length;n++)e.tableView[a.weekday][a.start+n]={length:a.length,No:n,show:!0,style:"",locate:"body"},0==n&&(e.tableView[a.weekday][a.start+n].locate="start"),n==a.length-1&&(e.tableView[a.weekday][a.start+n].locate="end");for(var n=0;4>n;n++){e.tableView[a.weekday][a.start+r+n].text1=t[o[n]]}}}e.tableView=[[],[],[],[],[],[]],e.tableView.forEach(function(e){for(var t=0;13>t;t++)e.push({length:1})});var r=[];a.forEach(function(e){e.forEach(function(e){0!=e&&r.push(e)})}),r.forEach(function(e){for(var a=e["时间"].split("{time}"),r=0;r<a.length;r++){var n=t.timeParser(a[r]);o(e,n)}})}o(t.courseModel.data),e.$on("courseModelUpdate",function(e,t){o(t)}),e.remove=function(e,a){var o=t.courseModel.data[e][a];t.courseModel.remove(o)},e.hover=function(t,a){for(var o="background:#ddd",r=e.tableView[a][t].No||0,n=e.tableView[a][t].length-r-1||0,i=0;r>=i;i++)e.tableView[a][t-i].style=o;for(var i=0;n>=i;i++)e.tableView[a][t+i].style=o},e.out=function(t,a){for(var o="",r=e.tableView[a][t].No||0,n=e.tableView[a][t].length-r-1||0,i=0;r>=i;i++)e.tableView[a][t-i].style=o;for(var i=0;n>=i;i++)e.tableView[a][t+i].style=o},e.showDetail=function(o,r){var n=n||window.event;if(0!==t.courseModel.data[o][r]){if(e.detail=t.courseModel.data[o][r],1==e.detailIsShow?(e.detailIsShow=!1,a(function(){e.detailIsShow=!0},0)):e.detailIsShow=!0,0===o||1===o||2===o){var i=n.layerY-100<0?0:n.layerY-100,l=15*(o+1)+10;e.detailPosition="top:"+i+"px;left:"+l+"%;"}if(3===o||4===o||5===o){var i=n.layerY-100<0?0:n.layerY-100,s=15*(6-o);e.detailPosition="top:"+i+"px;right:"+s+"%;"}}},e.closeDetail=function(){e.detailIsShow=!1},e.removeCourse=function(){t.courseModel.remove(e.detail)}}]),angular.module("starkAPP").controller("courseTotalController",["$scope","BaseService",function(e,t){function a(t){var a=[],o=[],r=0;t.forEach(function(e){e.forEach(function(e){0!=e&&-1===o.indexOf(e["选课序号"])&&(o.push(e["选课序号"]),a.push(e),r+=parseInt(e["学分"]))})}),e.list=a,e.totalCredit=r}a(t.courseModel.data),e.$on("courseModelUpdate",function(e,t){a(t)})}]),angular.module("starkAPP").controller("searchController",["$scope","BaseService","$timeout","$location",function(e,t,a,o){e.$on("showSearch",function(){$(".search").css("z-index","100"),e.searchShow=!0,a(function(){$(".search-bar input").focus()},700)}),e.close=function(){var t=t||window.event;/bg/.test(t.target.className)&&(e.searchShow=!1,a(function(){$(".search").css("z-index","-9999")},700))},e.kwChange=function(){var a={category:[],keywords:e.keywords,courseID:"",time:""},o=t.search(a);e.result=o,o.length>0?e.resultShow=!0:e.resultShow=!1},e.mouseover=function(){e.detail=this.course},e.courseUpdate=function(){t.courseModel.update(this.detail)}}]),angular.module("starkAPP").controller("sidebarController",["$scope","$rootScope","BaseService","$timeout","$location",function(e,t,a,o,r){"/main/"==r.path()&&(e.mainIsActive=!0),"/all/"==r.path()&&(e.allIsActive=!0),e.showSearch=function(){t.$broadcast("showSearch")}}]);